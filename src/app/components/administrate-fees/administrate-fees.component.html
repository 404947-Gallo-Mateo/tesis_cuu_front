<div class="container-fluid p-3" *ngIf="isLoaded">

  <div class="row pt-3 mb-3 d-flex align-items-center">
    <div class="col">
        <h2 class="mb-0">Gestión de Cuotas de mis Disciplinas</h2> 
    </div>
    <div class="col-auto">
        <button 
      class="btn btn-primary"
      (click)="toggleView()">
      {{ debtorMode ? 'Ver Disciplinas' : 'Ver Deudores' }}
    </button>
    </div>
  </div>

  <!-- Modo Normal: Lista de Disciplinas -->
  <div *ngIf="!debtorMode">
    <div *ngFor="let discipline of disciplines" class="card mb-3">
      <div 
        class="card-header d-flex justify-content-between align-items-center cursor-pointer"
        (click)="toggleDiscipline(discipline.id)">
        <h5 class="mb-0">{{ discipline.name }}</h5>
        <span>
          {{ disciplineInscriptions[discipline.id].expanded ? '▲' : '▼' }}
        </span>
      </div>

      <div *ngIf="disciplineInscriptions[discipline.id].expanded" class="card-body">
        <div *ngIf="disciplineInscriptions[discipline.id].loading" class="text-center">
          Cargando inscripciones...
        </div>

        <div *ngIf="!disciplineInscriptions[discipline.id].loading">
          <div *ngIf="disciplineInscriptions[discipline.id].inscriptions.length === 0" 
               class="alert alert-info">
            No hay inscripciones para esta disciplina
          </div>

            <!-- Barra de búsqueda para disciplinas (arriba de la tabla) -->
          <div class="row mb-3">
            <div class="col-md-6">
              <input 
                type="text" 
                class="form-control" 
                placeholder="Buscar por nombre o email..."
                [(ngModel)]="disciplineInscriptions[discipline.id].searchTerm">
            </div>
          </div>

          <table *ngIf="disciplineInscriptions[discipline.id].inscriptions.length > 0" 
                 class="table table-striped">
            <thead class="table-dark">
              <tr>
                <th>Deudor</th>
                <th>Estudiante</th>
                <th>Email</th>
                <th>Edad</th>
                <th>Género</th>
                <th>Disciplina</th>
                <th>Categoría</th>
                <th>Ver Cuotas</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let ins of filterInscriptions(disciplineInscriptions[discipline.id].inscriptions, disciplineInscriptions[discipline.id].searchTerm) | 
                    paginate: { 
                      id: discipline.id, 
                      itemsPerPage: itemsPerPage, 
                      currentPage: disciplineInscriptions[discipline.id].page 
                    }">
                <td>
                  <span *ngIf="ins.isDebtor" class="badge bg-danger">Deudor</span>
                  <span *ngIf="!ins.isDebtor" class="badge bg-success">Al día</span>
                </td>                
                <td>
                  {{ ins.student.firstName }} {{ ins.student.lastName }}                  
                </td>
                <td>{{ ins.student.email }}</td>
                <td>{{ ins.student.birthDate | age }} años</td>
                <td>{{ ins.student.genre | genre }}</td>
                <td>{{ ins.discipline.name }}</td>
                <td>{{ ins.category.name }}</td>
                <td class="text-center align-middle">
                  <button class="btn btn-sm btn-outline-success open-fees-modal" (click)="openFeesModal(ins.inscriptionFees)">
                    <i class="bi bi-cash-stack"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <pagination-controls 
            [id]="discipline.id"
            (pageChange)="disciplineInscriptions[discipline.id].page = $event">
          </pagination-controls>
        </div>
      </div>
    </div>
  </div>

  <!-- Modo Deudores: Tabla Única -->
  <div *ngIf="debtorMode">
    <h4 class="mb-3">Estudiantes Deudores</h4>
    
      <!-- Barra de búsqueda para deudores -->
    <div class="row mb-3">
      <div class="col-md-6">
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar por nombre o email..."
          [(ngModel)]="debtorSearchTerm">
      </div>
    </div>

    <div *ngIf="loadingDebtors" class="text-center">
      Cargando deudores...
    </div>

    <div *ngIf="!loadingDebtors">
      <div *ngIf="debtorInscriptions.length === 0" class="alert alert-info">
        No se encontraron estudiantes deudores
      </div>

      <table *ngIf="debtorInscriptions.length > 0" class="table table-striped">
            <thead class="table-dark">
          <tr>
            <th>Deudor</th>
            <th>Estudiante</th>
                <th>Email</th>
                <th>Edad</th>
                <th>Género</th>
                <th>Disciplina</th>
                <th>Categoría</th>
                <th>Ver Cuotas</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let ins of filterInscriptions(debtorInscriptions, debtorSearchTerm) | 
                    paginate: { 
                      itemsPerPage: itemsPerPage, 
                      currentPage: debtorPage 
                    }">
            <td>
                  <span *ngIf="ins.isDebtor" class="badge bg-danger">Deudor</span>
                  <span *ngIf="!ins.isDebtor" class="badge bg-success">Al día</span>
            </td>   
            <td>{{ ins.student.firstName }} {{ ins.student.lastName }}                
            </td>
            <td>{{ ins.student.email }}</td>
                <td>{{ ins.student.birthDate | age }} años</td>
                <td>{{ ins.student.genre | genre }}</td>
                <td>{{ ins.discipline.name }}</td>
                <td>{{ ins.category.name }}</td>
                <td class="text-center align-middle">
                  <button class="btn btn-sm btn-outline-success open-fees-modal" (click)="openFeesModal(ins.inscriptionFees)">
                    <i class="bi bi-cash-stack"></i>
                  </button>
                </td>
          </tr>
        </tbody>
      </table>
      <pagination-controls (pageChange)="debtorPage = $event"></pagination-controls>
    </div>
  </div>
</div>

<div *ngIf="!isLoaded" class="text-center">
  Cargando datos del usuario...
</div>

 <!-- Modal de cuotas -->
  <div *ngIf="showFeesModal" class="modal-backdrop fade show"></div>
  <div *ngIf="showFeesModal" class="modal fade show d-block" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <app-modal-student-fees
          [inscriptionFees]="selectedInscriptionFees"
          [currentUserRole]="currentUser.role"
          (feesUpdated)="handleFeeUpdated($event)"
          (closeModalEvent)="closeFeesModal()" 
        />
      </div>
    </div>
  </div>

