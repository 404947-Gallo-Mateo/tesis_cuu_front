<div class="container-fluid p-4">
  <h2 class="mb-4">Administración de Usuarios</h2>

  <!-- Barra de búsqueda -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="input-group">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input 
          type="text" 
          class="form-control" 
          placeholder="Buscar por nombre, email o rol..."
          (input)="onSearchChange($event)"
        >
        @if (searchTerm()) {
          <button class="btn btn-outline-secondary" type="button" (click)="searchTerm.set('')">
            <i class="bi bi-x"></i>
          </button>
        }
      </div>
    </div>
    <!-- <div class="col-md-6 text-end">
      <span class="badge bg-info">
        {{ totalItems() }} usuarios encontrados
      </span>
    </div> -->
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="text-center my-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <p>Cargando usuarios...</p>
    </div>
  }

  <!-- Error -->
  @if (error()) {
    <div class="alert alert-danger">
      {{ error() }}
    </div>
  }

  <!-- Tabla de usuarios -->
  @if (!loading() && users().length > 0) {
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Edad</th>
            <th>Género</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredUsers() | paginate: { 
            itemsPerPage: itemsPerPage(), 
            currentPage: currentPage(),
            totalItems: totalItems() 
          }">
            <td>{{ user.firstName }} {{ user.lastName }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.role | role }}</td>
            <td>{{ user.birthDate | age }}</td>
            <td>{{ user.genre | genre }}</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-outline-primary me-2" (click)="openUserFormModal(user)">
                <i class="bi bi-pencil"></i> Editar
              </button>
              <button class="btn btn-sm btn-outline-danger" (click)="deleteUser(user.keycloakId)">
                <i class="bi bi-trash"></i> Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginación -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
          Mostrando {{ (currentPage() - 1) * itemsPerPage() + 1 }} a 
          {{ Math.min(currentPage() * itemsPerPage(), totalItems()) }} 
          de {{ totalItems() }} usuarios
        </div>
        
        <pagination-controls
          previousLabel="Anterior"
          nextLabel="Siguiente"
          (pageChange)="currentPage.set($event)"
          [responsive]="true"
          [maxSize]="5"
          class="my-pagination">
        </pagination-controls>
      </div>
    </div>
  }

  <!-- Sin resultados -->
  @if (!loading() && users().length === 0) {
    <div class="alert alert-info">
      No se encontraron usuarios registrados.
    </div>
  }

  @if (showModal()) {
    <div class="modal fade show d-block" id="adminUserFormModal" tabindex="-1" aria-labelledby="adminUserFormModalLabel" aria-hidden="true" [class.show]="showModal()">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="adminUserFormModalLabel">Editar Usuario</h5>
            <button type="button" class="btn-close" (click)="closeModal()" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            @if (userSelected) {
              <app-admin-user-dto-form 
                [userData]="userSelected"
                (modalClosed)="onUserUpdated($event)" />
            }
          </div>
        </div>
      </div>
    </div>
    <div class="modal-backdrop fade show" (click)="closeModal()"></div>
  }

</div>